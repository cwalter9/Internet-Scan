MYSQLQ="mysql -Dinternetscan -s"
cdate=`date +%F`

function getvar {
  cat config | grep $1 | gawk -F= '{ print $2 }'
}

function dblog {
  echo "insert into log set pid='$1',entry='$2'" | $MYSQLQ
}

workdir=`getvar FileWorkDir`

cd $workdir

function checkproxy {
  curl -s -S --connect-timeout 5 -x http://$1 http://www.walternet.com/wtime
}

function funstart {
  stime=`date +%s`
  dblog $1 "Start $stime"
}

function funstop {
  ftime=`date +%s`
  totime=`echo "$ftime - $stime" | bc`
  rm -rf $runfile
  dblog $1 "Finish $totime"
}

function resethost {
  dblog reset "Resetting host $1 for rescan"
  addid=`echo "select addid from address where ipaddr='$1'" | $MYSQLQ`
  echo "delete from ports where addid='$addid'" | $MYSQLQ
  echo "delete from service where addid='$addid'" | $MYSQLQ
  ctime=`date +%s`
  echo "update address set status=1,updown=0,utime='$ctime' where ipaddr='$1'" | $MYSQLQ
}

function checkprocess {
  if [ -f $2 ]; then
    dblog $1 "Already running exit 2"
    exit 2
  else
    touch $2
    echo "$$" > $2
  fi
}

function chkmkdir {
  if [ ! -d $1 ]; then
    mkdir $1
  fi
}

processname=`echo $0 | sed 's/.\///'`
funstart $processname
runfile="/tmp/$processname"
checkprocess $processname $runfile
