#!/bin/bash

cd /admin/iscan

. functions

runfile='/tmp/scanadd'
runlimit=`cat config | grep AddressScanRun | gawk -F= '{ print $2 }'`
addrdir=`cat config | grep FileAddrDir | gawk -F= '{ print $2 }'`
runcount=5

if [ -f $runfile ]; then
  exit 2
else
  touch $runfile
fi

for i in `echo "select addid from address where status=1 limit $runlimit" | $MYSQLQ`; do
  address=`echo "select ipaddr from address where addid='$i'" | $MYSQLQ`

  nmap --host-timeout 30 -sn "$address" -oG address/$address
  echo "update address set status=2 where addid='$i'" | $MYSQLQ

done

rm -rf $runfile
